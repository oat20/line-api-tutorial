import{__assign as e,__awaiter as t,__generator as r,__read as n}from"tslib";import{convertHexToRgb as o,convertArgbToRgba as i,createLiffError as a,base64Url as s,convertArrayBuffer as l,compareVersion as c,qs as u,extractChannelIdFromLiffId as f,objectAssignKeyOnlyWithValue as d,addParamsToUrl as h,replaceUrlCredentialRemoved as p}from"@liff/util";import{done as v}from"@liff/ready";import{isLoggedIn as m}from"@liff/is-logged-in";import{getContext as w,getLoginTmp as g,getExpireTime as b,getIsSubsequentLiffApp as C,getFeatureToken as k,setIsSubsequentLiffApp as F,getMST as _,getAccessToken as y,getRawContext as B,getIDToken as I,getClientId as x,getMSTChallenge as S,getMSTVerifier as T,getMSIT as A,getConfig as E,setDecodedIDToken as D,setAppData as L,setMST as O,setFeatureToken as U,setAccessToken as P,setContext as N,setMSTChallenge as K,setMSTVerifier as W,setClientId as M,setMSIT as j,setIDToken as H,getDecodedIDToken as V,removeLoginTmp as J,setExpireTime as q,setConfig as R,clearAutologinAttempt as z,setAutologinAttempt as G,getAutologinAttempt as Q}from"@liff/store";import{INIT_FAILED as X,INVALID_ID_TOKEN as Y,FORBIDDEN as Z,SUB_WINDOW_HEALTH_CHECK_MESSAGE as $,INVALID_CONFIG as ee}from"@liff/consts";import{load as te}from"@liff/extensions";import{isInClient as re}from"@liff/is-in-client";import{logout as ne}from"@liff/logout";import{isSubWindow as oe}from"@liff/is-sub-window";import{getMSTByMSIT as ie,getAppData as ae,getMainWindowOrigin as se,setMainWindowOrigin as le}from"@liff/sub-window";import{fetch as ce,getEndPoint as ue,verifyAccessToken as fe}from"@liff/server-api";import de from"js-crypto-ec";import{getOS as he}from"@liff/get-os";import{logger as pe}from"@liff/logger";import{getLineVersion as ve}from"@liff/get-line-version";import{addListener as me,removeListener as we}from"@liff/native-bridge";import{isApiAvailable as ge}from"@liff/is-api-available";var be={iconColor:"#111111",statusBarColor:"BLACK",titleTextColor:"#111111",titleSubtextColor:"#B7B7B7",titleButtonColor:"#111111",titleBackgroundColor:"#FFFFFF",progressBarColor:"#06C755",progressBackgroundColor:"#FFFFFF",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#FFFFFF",baseTextColor:"#000000",lightButtonBorderColor:"rgba(0, 0, 0, 0.15)"},Ce={iconColor:"#FFFFFF",statusBarColor:"WHITE",titleTextColor:"#FFFFFF",titleSubtextColor:"#949494",titleButtonColor:"#FFFFFF",titleBackgroundColor:"#111111",progressBarColor:"#06C755",progressBackgroundColor:"#111111",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#000000",baseTextColor:"#FFFFFF",lightButtonBorderColor:"rgba(255, 255, 255, 0.5)"};function ke(){var e;ye("color-scheme",((null==(e=w())?void 0:e.menuColorSetting)||{adaptableColorSchemes:["light"]}).adaptableColorSchemes.join(" "));var t=window.matchMedia("(prefers-color-scheme: dark)");Fe({matches:null==t?void 0:t.matches,media:null==t?void 0:t.media}),t.addEventListener?t.addEventListener("change",Fe):t.addListener&&t.addListener(Fe)}function Fe(t){var r=w(),n=(null==r?void 0:r.menuColorSetting)||{adaptableColorSchemes:["light"],lightModeColor:be,darkModeColor:Ce},o=n.adaptableColorSchemes,i=n.lightModeColor,a=n.darkModeColor,s=o.includes("dark");t.matches&&s?_e(e(e({},Ce),a)):_e(e(e({},be),i))}function _e(e){var t=e.iconColor,r=e.statusBarColor,n=e.titleTextColor,a=e.titleSubtextColor,s=e.titleButtonColor,l=e.titleBackgroundColor,c=e.progressBarColor,u=e.progressBackgroundColor,f=e.titleButtonAreaBackgroundColor,d=e.titleButtonAreaBorderColor,h=e.baseBackgroundColor,p=e.baseTextColor,v=e.lightButtonBorderColor;ye("--liff-base-background-color",h),ye("--liff-base-text-color",p),ye("--liff-base-background-rgb-color",o(h)),ye("--liff-base-text-rgb-color",o(p)),ye("--liff-light-button-border-color",v),ye("--liff-title-text-color",n),ye("--liff-title-background-color",l),ye("--liff-title-button-color",s),ye("--liff-icon-color",t),ye("--liff-status-bar-color",r),ye("--liff-title-subtext-color",a),ye("--liff-progress-bar-color",c),ye("--liff-progress-background-color",u),ye("--liff-title-button-area-background-color",i(f)),ye("--liff-title-button-area-border-color",i(d))}function ye(e,t){document.documentElement.style.setProperty(e,t)}function Be(e){return t(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,te()];case 1:return t.sent().install(e),[2]}}))}))}function Ie(){return t(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,ce(ue("certs"))];case 1:return[2,e.sent()]}}))}))}var xe=function(){return"ios"===he()&&(null!==(e=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/))&&parseInt(e[1],10)<=10);var e};function Se(e,n,o){return t(this,void 0,void 0,(function(){var t,i;return r(this,(function(r){switch(r.label){case 0:return xe()?(t=de.verify(n,o,e,"SHA-256","raw"),[3,4]):[3,1];case 1:return[4,crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])];case 2:return i=r.sent(),[4,crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},i,o,n)];case 3:t=r.sent(),r.label=4;case 4:return[2,t]}}))}))}function Te(e,o){return t(this,void 0,void 0,(function(){var t,i,c,u,f,d,h,p,v,m,w,g,b,C,k,F;return r(this,(function(r){switch(r.label){case 0:return t=e.split("."),i=n(t,3),c=i[0],u=i[1],f=i[2],d=JSON.parse(s.decode(c)),h=JSON.parse(s.decodeUnicode(u)),p=l(s.decode(f)),v=l(c+"."+u),[4,Ie()];case 1:if(m=r.sent(),!(w=m.keys.find((function(e){return e.kid===d.kid}))))return[3,6];if(delete w.alg,"ES256"!==d.alg)throw a(Y,'Invalid "alg" value in ID_TOKEN');g=void 0,r.label=2;case 2:return r.trys.push([2,4,,5]),[4,Se(w,v,p)];case 3:return g=r.sent(),[3,5];case 4:throw b=r.sent(),a(Y,"Failed to use Crypto API to verify ID_TOKEN: "+b);case 5:if(g){if(C="https://access.line.me"!==h.iss,k=h.aud!==o,F=1e3*h.exp<Date.now(),C)throw a(Y,'Invalid "iss" value in ID_TOKEN');if(k)throw a(Y,'Invalid "aud" value in ID_TOKEN');if(F)throw a(Y,'Invalid "exp" value in ID_TOKEN');return[2,h]}throw a(Y,"Invalid signature in ID_TOKEN");case 6:throw a(Y,'Invalid "kid" value in ID_TOKEN');case 7:return[2]}}))}))}function Ae(e){var t=e.split(".");if(t[1])try{var r=t[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(r))}catch(n){return null}return null}function Ee(e){var t=e.pathname,r=e.query,n="liff://"+t+(r?"?"+u.stringify(r):"");location.href=n}var De=null;function Le(){"boolean"==typeof De&&pe.warn("liff.init is not expected to be called more than once"),De=!!C()||!(!re()||u.parse(window.location.hash).feature_token||k())&&(F(!0),!0)}function Oe(){return Boolean(De)}function Ue(e,n){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:return(t=_())?[2,t]:e&&n?[4,ie({msit:e,mstVerifier:n})]:[3,2];case 1:return[2,r.sent().mst];case 2:return[2,null]}}))}))}function Pe(e){return ce(ue("apps")+"/"+e+"/featureToken")}function Ne(e){return t(this,void 0,void 0,(function(){var t,n,o,i,a,s,l;return r(this,(function(r){switch(r.label){case 0:return t=u.parse(window.location.hash),n=d({access_token:y(),context_token:B(),feature_token:k(),id_token:I(),client_id:x(),mst_challenge:S(),mst_verifier:T(),msit:A()},t),Oe()?m()?[4,Pe(e)]:[3,2]:[3,3];case 1:i=r.sent(),a=i.featureToken,s=i.features,o=s,n.feature_token||(n.feature_token=a),r.label=2;case 2:(l=f(e))&&(n.client_id=l),r.label=3;case 3:return[2,{credentials:n,features:o}]}}))}))}function Ke(e){if(e.persisted&&ge("multipleLiffTransition"))if("ios"===he())window.location.reload();else{var t=E().liffId,r=k();if(!t)throw a(X,"Invalid LIFF ID.");if(!r)throw a(Z,"Invalid featureToken for client features");Ee({pathname:"app/"+t,query:{feature_token:r}})}}function We(e,n){return t(this,void 0,void 0,(function(){var t,o;return r(this,(function(r){switch(r.label){case 0:return[4,fe(e)];case 1:return t=r.sent().client_id,o=f(n),[2,t===o]}}))}))}function Me(e,n){return t(this,void 0,void 0,(function(){var t,o,i,s,l,u,f,d,p,v,w,g,b;return r(this,(function(r){switch(r.label){case 0:return[4,new Promise((function(e){var t=ve();if(!t||c(t,"9.5.0")<0)e();else if(window._liff&&window._liff.features)e();else{pe.debug("cannot find window._liff.features, listen to ready event");var r=function(){pe.debug("ready event is fired"),we("ready",r),e()};me("ready",r)}}))];case 1:return r.sent(),Le(),[4,Ne(n.liffId)];case 2:return t=r.sent().credentials,o=t.access_token,i=t.context_token,s=t.feature_token,l=t.id_token,u=t.client_id,f=t.mst_verifier,d=t.mst_challenge,p=t.msit,!oe()&&s&&(!function(e,t){ge("multipleLiffTransition")&&Ee({pathname:"app/"+e,query:{feature_token:t}})}(n.liffId,s),Oe()&&U(s)),i&&N(Ae(i)),d&&K(d),f&&W(f),u&&M(u),p&&j(p),window.addEventListener("pageshow",Ke),m()?[3,7]:s&&o?[3,5]:Oe()?(v=h(location.href,{"liff.hback":"2"}),e.login({redirectUri:v}),[4,new Promise((function(){}))]):[3,4];case 3:r.sent(),r.label=4;case 4:throw e.login(),a(X,"Failed to parse feature_token or access_token");case 5:return[4,We(o,n.liffId)];case 6:if(!r.sent())throw e.login(),a(X,"Failed to verify access_token");U(s),P(o),r.label=7;case 7:return[4,Ue(p,f)];case 8:return(w=r.sent())?(O(w),[4,ae({mst:w})]):[3,10];case 9:(g=r.sent().data)&&L(JSON.stringify(g)),r.label=10;case 10:return l&&!I()&&H(l),l&&u&&!V()?[4,Te(l,u)]:[3,12];case 11:(b=r.sent())&&D(b),r.label=12;case 12:return[2]}}))}))}function je(e){return t(this,void 0,void 0,(function(){var t,n,o,i,s,l,c;return r(this,(function(r){switch(r.label){case 0:return t=ue("apps"),n=t+"/"+e+"/contextToken",o=y(),i={"Content-Type":"application/json",Accept:"application/json"},o&&(i.Authorization="Bearer "+o),[4,ce(n,{headers:i})];case 1:if(s=r.sent(),!(l=s.contextToken))throw a(X,"Can not get context from server.");if(!(c=Ae(l)))throw a(X,"Invalid context token.");return[2,c]}}))}))}function He(){return t(this,void 0,void 0,(function(){var e,t;return r(this,(function(r){switch(r.label){case 0:if(!(e=E().liffId))throw a(X,"Invalid LIFF ID.");return[4,je(e)];case 1:return t=r.sent(),N(t),[2]}}))}))}function Ve(e){return t(this,void 0,void 0,(function(){var n,o,i,a=this;return r(this,(function(s){switch(s.label){case 0:n=function(){return t(a,void 0,void 0,(function(){var t,n,o,i,a,s;return r(this,(function(r){switch(r.label){case 0:return[4,(l=E(),c=u.parse(window.location.search),f=g(),d={grant_type:"authorization_code",client_id:c.liffClientId,appId:l.liffId,code:c.code,code_verifier:f.codeVerifier,redirect_uri:l.redirectUri||c.liffRedirectUri,id_token_key_type:"JWK"},h=u.stringify(d),ce(ue("token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:h}))];case 1:return t=r.sent(),n=t.access_token,o=t.id_token,i=t.expires_in,M(e),P(n),q(new Date(Date.now()+1e3*i)),J(),o?(H(o),[4,Te(o,e)]):[3,3];case 2:(a=r.sent())&&D(a),r.label=3;case 3:return(s=u.parse(location.hash).context_token)?(N(Ae(s)),[3,6]):[3,4];case 4:return[4,He()];case 5:r.sent(),r.label=6;case 6:return[2]}var l,c,f,d,h}))}))},s.label=1;case 1:return s.trys.push([1,3,,4]),[4,n()];case 2:return s.sent(),[3,4];case 3:throw o=s.sent(),i=o,J(),i;case 4:return[2]}}))}))}var Je=new(function(){function e(){var e=this;this.getAndValidateContext=function(){var e=w();if(!e)throw a(X,"Could not get Context from server.");if(!e.endpointUrl)throw a(X,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw a(X,"Could not get permanentLinkPattern from server.");return e},this.decodeState=function(t){var r=e.getAndValidateContext();t=t.replace(/\n/g,"%0D%0A");var n=!r.endpointUrl.startsWith("/?")&&r.endpointUrl.includes("/?")||!r.endpointUrl.startsWith("/#")&&r.endpointUrl.includes("/#")||r.endpointUrl.endsWith("/")||!t.startsWith("/?")&&t.includes("/?")||!t.startsWith("/#")&&t.includes("/#")||t.endsWith("/"),o=new URL(r.endpointUrl),i=o.origin,a=o.pathname,s=o.search,l=new URL(""+i+e.attachSlashAtStart(t)),c=l.pathname,u=l.search,f=l.hash,d=""+s+(s?u.replace(/\?/g,"&"):u),h=(""+a+e.attachSlashAtStart(c)).replace("//","/");return(h=e.attachSlashAtStart(""+h)).endsWith("/")&&!n&&(h=h.substring(0,h.length-1)),(""+i+h+d+f).replace(/%0D%0A/g,"\n")}}return e.prototype.attachSlashAtStart=function(e){return(e&&e.length>0&&!e.startsWith("/")?"/":"")+e},e.prototype.invoke=function(){return t(this,void 0,void 0,(function(){var e,t,n,o,i;return r(this,(function(r){switch(r.label){case 0:if(e=u.parse(window.location.search),"string"!=typeof(t=e["liff.state"]))return[2];r.label=1;case 1:return r.trys.push([1,4,,5]),n=location.href,(o=this.decodeState(t))===n?[3,3]:(e["liff.hback"]?location.replace(h(o,{"liff.hback":e["liff.hback"]})):location.replace(o),[4,new Promise((function(){}))]);case 2:r.sent(),r.label=3;case 3:return[3,5];case 4:if((i=r.sent()).code===X)throw i;return pe.debug(i),[3,5];case 5:return[2]}}))}))},e}());function qe(e,n,o){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:if(!o.liffId)throw a(ee,"liffId is necessary for liff.init()");return R(o),!re()&&m()&&(b()||ne()),t=u.parse(window.location.search),!oe()||re()?[3,2]:[4,new Promise((function(e){se()?e():window.addEventListener("message",(function t(r){var n=r.data,o=r.source,i=r.origin;if(n){var a=n.type,s=n.message;a===$&&(window.removeEventListener("message",t),s&&L(s),le(i),o&&o.postMessage&&o.postMessage({status:$},i),e())}}))}))];case 1:r.sent(),r.label=2;case 2:if(t.error&&t.liffOAuth2Error)throw l=t.error,c=t.error_description,f=c.replace(/\+/g," "),a(X,l+": "+f);return i=t.code,s=g(),Boolean(i&&!m()&&s&&s.codeVerifier)?[4,Ve(t.liffClientId)]:[3,4];case 3:r.sent(),r.label=4;case 4:return re()?[4,Me(e,o)]:[3,6];case 5:return r.sent(),[3,8];case 6:return m()?[3,8]:[4,He()];case 7:r.sent(),r.label=8;case 8:return[4,Je.invoke()];case 9:return r.sent(),[4,n.runHook("beforeInitFinished")];case 10:return r.sent(),p(window.location.href),[2]}var i,s,l,c,f}))}))}var Re=function(){function e(e){this.moduleDriver=e}return Object.defineProperty(e.prototype,"name",{get:function(){return"init"},enumerable:!1,configurable:!0}),e.prototype.install=function(e){var t=e.liff;return this.liff=t,this.init.bind(this)},e.prototype.init=function(e,n,o){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:i=this.liff,window&&!window.liff&&(window.liff=i),r.label=1;case 1:return r.trys.push([1,9,,11]),[4,Promise.all([Be(this.liff),qe(this.liff,this.moduleDriver,e)])];case 2:return r.sent(),ke(),[4,this.moduleDriver.runHook("beforeInitSuccess")];case 3:if(r.sent(),!e.withLoginOnExternalBrowser||m())return[3,7];if(!Q())return[3,4];throw a(X,"Auto login failure");case 4:return G(),this.liff.login(),[4,new Promise((function(){}))];case 5:r.sent(),r.label=6;case 6:return[3,8];case 7:e.withLoginOnExternalBrowser&&z(),r.label=8;case 8:return"function"==typeof n&&n(),v(),[3,11];case 9:return t=r.sent(),[4,this.moduleDriver.runHook("initError",t)];case 10:throw r.sent(),"function"==typeof o&&o(t),t;case 11:return[2]}var i}))}))},e}();export{Re as InitModule};
