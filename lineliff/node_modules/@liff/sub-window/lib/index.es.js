import{STORE_KEY as e,INVALID_CONFIG as t,EXCEPTION_IN_SUBWINDOW as n,INVALID_ARGUMENT as r,SUB_WINDOW_IDNTIFICATION_KEY as i,CREATE_SUBWINDOW_FAILED as o,SUB_WINDOW_HEALTH_CHECK_INTERVAL as s,SUB_WINDOW_MONITOR_CLOSE_INTERVAL as u,SUB_WINDOW_SUBMIT_STATUS as a,SUB_WINDOW_CANCEL_STATUS as c,SUB_WINDOW_HEALTH_CHECK_MESSAGE as f,SUB_WINDOW_CLOSE_STATUS as l,UNKNOWN as m,SUB_WINDOW_ERROR_STATUS as d,UNAUTHORIZED as p,SUB_WINDOW_MODAL_SCHEME_URL as h,FORBIDDEN as v}from"@liff/consts";import{createLiffError as w,inMemoryStorage as g,extractLiffId as b,isIpad as S}from"@liff/util";import{isInClient as y}from"@liff/is-in-client";import{isApiAvailable as I}from"@liff/is-api-available";import{__awaiter as P,__generator as O,__spread as C,__read as j}from"tslib";import{logger as L}from"@liff/logger";import{getOS as E}from"@liff/get-os";import{fetch as N,getEndPoint as W,requestWithoutErrorHandling as J}from"@liff/server-api";import{getConfig as D,getMSTChallenge as T,getMST as x,getAppData as M}from"@liff/store";import{isSubWindow as B}from"@liff/is-sub-window";import{closeWindow as U}from"@liff/close-window";function k(e){var t=W("subWindowGetOrigin");return N(t(e))}var G={};function K(e,t){e&&G[e]&&G[e].forEach((function(e){e(t)}))}var A,R,V,F,_=function(){function n(e){this.storage=e}return n.prototype.getItem=function(e){return this.storage.getItem(this.getKeyPrefix()+":"+e)},n.prototype.setItem=function(e,t){this.storage.setItem(this.getKeyPrefix()+":"+e,t)},n.prototype.removeItem=function(e){this.storage.removeItem(this.getKeyPrefix()+":"+e)},n.prototype.clear=function(){this.storage.clear()},n.prototype.getKeyPrefix=function(){return e+":"+this.getLiffId()},n.prototype.getLiffId=function(){var e=D().liffId;if(!e)throw w(t,"liffId is necessary for liff.init()");return e},n}(),q=new _(g);function z(){var e=q.getItem("subWindowStatusUpdated");return null!==e&&JSON.parse(e)}function H(e){q.setItem("subWindowStatusUpdated",String(e))}function Q(e){A=e}function X(){return A}function Y(){return V}var Z=new _(window.sessionStorage);function $(e){Z.setItem("mainWindowOrigin",e)}function ee(){return Z.getItem("mainWindowOrigin")}function te(e,t){return void 0===t&&(t={}),P(this,void 0,void 0,(function(){var r,i,o,s,u,a,c;return O(this,(function(f){switch(f.label){case 0:if(r=D().liffId,i=ee(),!window.opener||!i||!r)throw w(n);o=!1,f.label=1;case 1:return f.trys.push([1,3,,4]),[4,k(r)];case 2:return s=f.sent(),o=s.subwindowCommonModule,[3,4];case 3:throw u=f.sent(),L.debug(u),w(n);case 4:return a=JSON.stringify(t),c=o?i:location.origin,window.opener.postMessage({status:e,result:a},c),[2,{status:e,result:a}]}}))}))}function ne(e){var t=F;if(e.origin===t){var n=e.data;if(n){var r,i=n.status,o=n.result;try{r=JSON.parse(o||"{}")}catch(s){r={}}switch(i){case f:window.clearInterval(Y());break;case c:case a:H(!0),window.clearInterval(Y()),window.removeEventListener("message",ne),K(i,r);break;default:L.debug("unexpected message")}}}}function re(){window.clearInterval(R),window.clearInterval(Y()),window.removeEventListener("message",ne)}function ie(e){var t=b(e.url);if(!t)return Promise.reject(w(r,"params.url must be liff url"));!function(){re(),H(!1);var e=X();e&&(e.close(),Q(null))}();var n,a,c,m,d=e.url,p=e.appData,h=new URL(d);h.searchParams.append(i,"true"),h.hostname=(n=h.hostname,a=j(n.split(".")),c=a[0],m=a.slice(1),C([c+"-ext"],m).join("."));var v=h.toString();return Q("ios"!==E()||S()?window.open("","liffsubwindow","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):window.open()),k(t).then((function(e){var t,n=e.origin,r=e.subwindowCommonModule,i=X();if(!i)throw w(o);r?(!function(e){F=e}(n),window.addEventListener("message",ne),i.location.href=v,t=function(e,t){var n=X(),r={type:f};return t&&(r.message=JSON.stringify(t)),window.setInterval((function(){null==n||n.postMessage(r,e)}),s)}(n,p),V=t,function(e){R=e}(window.setInterval((function(){var e=X();e&&e.closed&&(re(),Q(null),!1===z()&&(H(!0),K(l,{})))}),u))):i.close()}))}function oe(e){return P(this,void 0,void 0,(function(){var t,n,i,o,s,u,f,p,h,v,g;return O(this,(function(b){switch(b.label){case 0:t=e.msit,n=e.mstChallenge,i=e.onSuccess,o=e.onError,s=e.reconnectCount,u=void 0===s?0:s,b.label=1;case 1:return b.trys.push([1,3,,6]),[4,J(W("subWindowSubscribe"),{method:"POST",body:JSON.stringify({msit:t,mstChallenge:n})})];case 2:return f=b.sent(),[3,6];case 3:return b.sent(),[4,se()];case 4:return b.sent(),[4,ae(oe,{msit:t,mstChallenge:n,onSuccess:i,onError:o,reconnectCount:u+=1})];case 5:return b.sent(),[2];case 6:return f.status>=500?[4,se()]:[3,9];case 7:return b.sent(),[4,ae(oe,{msit:t,mstChallenge:n,onSuccess:i,onError:o,reconnectCount:u+=1})];case 8:return b.sent(),[3,20];case 9:return f.status>=400&&500>f.status?[4,ue(f)]:[3,11];case 10:return(h=b.sent())?(p=h.errorDetail,o(w(r,p))):o(w(m,"Some error happened in the server")),[3,20];case 11:return 200!==f.status?[3,19]:[4,ue(f)];case 12:return(h=b.sent())?[3,13]:(o(w(m,"Some error happened in the server")),[3,18]);case 13:switch(v=h.status,g=h.result,v){case d:return[3,14];case l:case c:case a:return[3,16]}return[3,17];case 14:return[4,ae(oe,{msit:t,mstChallenge:n,onSuccess:i,onError:o,reconnectCount:u})];case 15:return b.sent(),[3,18];case 16:return i(v,g),[3,18];case 17:o(w(m,"Some error happened in the server")),b.label=18;case 18:return[3,20];case 19:o(w(m,"Some error happened in the server")),b.label=20;case 20:return[2]}}))}))}function se(){return new Promise((function(e){return setTimeout(e,1e3)}))}function ue(e){return P(this,void 0,void 0,(function(){return O(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,e.json()];case 1:return[2,t.sent()];case 2:return t.sent(),[2,null];case 3:return[2]}}))}))}function ae(e,t){return P(this,void 0,void 0,(function(){return O(this,(function(n){switch(n.label){case 0:return t.reconnectCount>=10?(t.onError(w(m,"Failed to connect")),[3,3]):[3,1];case 1:return[4,e(t)];case 2:n.sent(),n.label=3;case 3:return[2]}}))}))}function ce(e){var t={};return Object.keys(e).forEach((function(n){"closeButtonColor"===n?"white"===e[n]?t[n]="#ffffff":t[n]="#000000":t[n]=e[n]})),t}var fe={height:"full",closeButtonPosition:"right",closeButtonColor:"black",closeButtonLabel:""};function le(e){var t=e.appData,n=e.native,i=D().liffId,o=T(),s=b(e.url);if(!i)return Promise.reject(w(p,"liffId is invalid"));if(!o)return Promise.reject(w(p,"mst_challenge is invalid"));if(!s)return Promise.reject(w(r,"params.url must be liff url"));var u=Object.assign({},fe,n);return function(e){var t=e.mainLiffId,n=e.subLiffId,i=e.mstChallenge,o=e.appData,s=e.view;return t&&i?N(W("subWindowGetMSIT"),{method:"POST",body:JSON.stringify({mainLiffId:t,subLiffId:n,mstChallenge:i,appData:o,view:s})}):Promise.reject(w(r,"no proper argument"))}({mainLiffId:i,subLiffId:s,mstChallenge:o,appData:t,view:ce(u)}).then((function(t){var n=t.msit;oe({msit:n,mstChallenge:o,onSuccess:function(e,t){K(e,t)},onError:function(e){K(d,e)}}),function(e,t){var n=e.url,r=new URLSearchParams;r.set("msit",t),location.href=h+"?url="+encodeURIComponent(n)+"&"+r.toString()}(e,n)}))}function me(){if(!B())throw w(p,"this api can be only called in child window")}function de(e){if(!e.mst||!e.status)return Promise.reject(w(r,"no proper argument"));var t=JSON.stringify(e);return N(W("subWindowPost"),{method:"POST",body:t})}function pe(e){var t=e.msit,n=e.mstVerifier;return t&&n?N(W("subWindowGetMSTByMSIT"),{method:"POST",body:JSON.stringify({msit:t,mstVerifier:n})}):Promise.reject(w(r,"no proper argument"))}function he(e){var t=e.mst;return t?N(W("subWindowGetAppData"),{method:"POST",body:JSON.stringify({mst:t})}):Promise.reject(w(r,"no proper argument"))}var ve={on:function(e,t){G[e]||(G[e]=[]),G[e].push(t)},off:function(e,t){if(G[e]){var n=G[e].indexOf(t);n>=0&&G[e].splice(n,1)}},open:function(e){if(!I("subwindowOpen"))throw w(v,"No permission for liff.subWindow.open()");return function(){if(B())throw w(p,"this api can be only called in parent window")}(),y()?le(e):ie(e)},cancel:function(e){return void 0===e&&(e={}),me(),y()?function(e){return void 0===e&&(e={}),P(this,void 0,void 0,(function(){var t,n;return O(this,(function(r){switch(r.label){case 0:return(t=x())?[4,de({mst:t,status:c,result:e})]:[2,Promise.reject(w(p,"mst is invalid"))];case 1:return n=r.sent(),H(!0),[2,n]}}))}))}(e):function(e){return void 0===e&&(e={}),te(c,e)}(e)},submit:function(e){return void 0===e&&(e={}),me(),y()?function(e){return void 0===e&&(e={}),P(this,void 0,void 0,(function(){var t,n;return O(this,(function(r){switch(r.label){case 0:return(t=x())?[4,de({mst:t,status:a,result:e})]:[2,Promise.reject(w(p,"mst is invalid"))];case 1:return n=r.sent(),H(!0),[2,n]}}))}))}(e):function(e){return void 0===e&&(e={}),te(a,e)}(e)},close:function(){return me(),y()?function(){return P(this,void 0,void 0,(function(){var e;return O(this,(function(t){switch(t.label){case 0:return!1!==z()?[3,2]:(e=x())?[4,de({mst:e,status:l,result:{}})]:[2,Promise.reject(w(p,"mst is invalid"))];case 1:t.sent(),t.label=2;case 2:return U(),[2]}}))}))}():(U(),Promise.resolve())},getAppData:function(){return me(),function(){var e,t=M();try{e=t?JSON.parse(t):{}}catch(n){e={}}return Promise.resolve(e)}()}};export{he as getAppData,pe as getMSTByMSIT,ee as getMainWindowOrigin,$ as setMainWindowOrigin,ve as subWindow};
